<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>급식 천국</title>
</head>
<body>
<div id="map" style="width:100%;height:100vh;"></div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=06afb75f198d3177cfcff4f757f0bfa2"></script>
<script>

var mapContainer = document.getElementById('map'), // 지도를 표시할 div  
    mapOption = { 
        // 기본 중심좌표 설정 (울산 중심좌표)
        center: new kakao.maps.LatLng(35.5372, 129.3114), // 지도의 중심좌표
        level: 10 // 지도의 확대 레벨
    };

var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

var prevInfowindow = null; // 이전에 열린 인포윈도우를 저장할 변수

// 사용자의 현재 위치를 가져와서 지도의 중심으로 설정
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
        var lat = position.coords.latitude; // 현재 위치의 위도
        var lng = position.coords.longitude; // 현재 위치의 경도
        
        // 현재 위치로 지도의 중심을 이동
        var moveLatLon = new kakao.maps.LatLng(lat, lng);
        map.setCenter(moveLatLon);
    });
}

getData();
function getData() {
    // fetch를 사용하여 POST 요청 보내기
    fetch('/getschool')
    .then(response => response.json())
    .then(data => {
        data = data.res;
        data.forEach(element => {
            var position = {
                content: `<div><p>${element['학교명']}</p>
                            <p>${element['급식메뉴']}</p></div>`, 
                latlng: new kakao.maps.LatLng(element['위도'], element['경도'])  
            };

            // 마커를 생성합니다
            var marker = new kakao.maps.Marker({
                map: map, // 마커를 표시할 지도
                position: position.latlng // 마커의 위치
            });

            // 마커에 표시할 인포윈도우를 생성합니다 
            var infowindow = new kakao.maps.InfoWindow({
                content: position.content // 인포윈도우에 표시할 내용
            });

            // 마커에 mouseover 이벤트를 등록합니다
            kakao.maps.event.addListener(marker, 'mouseover', function() {
                infowindow.open(map, marker);
            });

            // 마커에 click 이벤트를 등록합니다
            kakao.maps.event.addListener(marker, 'click', function() {
                // 이전에 열린 인포윈도우가 있다면 닫기
                if (prevInfowindow) {
                    prevInfowindow.close();
                }
                
                // 클릭된 마커에 인포윈도우 열기
                infowindow.open(map, marker);
                
                // 현재 열린 인포윈도우를 prevInfowindow에 저장
                prevInfowindow = infowindow;
            });

            // 마커에 mouseout 이벤트를 등록합니다
            kakao.maps.event.addListener(marker, 'mouseout', function() {
                infowindow.close();
            });
        });
    })
    .catch(err => {
        console.error('전송에러', err); // 전송 에러 발생 시 콘솔에 로그 출력
    });
}
</script>
</body>
</html>
