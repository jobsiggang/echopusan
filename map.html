<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>부산광역시 교통 지수 지도</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            color: #333333;
            text-align: center;
            padding: 20px;
            font-size: 20px;

        }
   
        #map {
            width: 100%;
            height: 90vh;
            border: 2px solid #FFDEAD;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        .infowindow {
            font-size: 2em;
            color: #333;
            background: #FFE4B5;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div id="map"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=06afb75f198d3177cfcff4f757f0bfa2"></script>
    <script>
        var mapContainer = document.getElementById('map'),
            mapOption = { 
                center: new kakao.maps.LatLng(35.1796, 129.0756), // 부산시청 중심좌표
                level: 8 // 지도의 확대 레벨
            };

        var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

        var prevInfowindow = null; // 이전에 열린 인포윈도우를 저장할 변수

        async function loadCSV() {
            const response = await fetch('data.csv');
            const text = await response.text();
            const rows = text.split('\n').slice(1); // 헤더 행을 제외하고 데이터 행만 가져옴
            console.log(text);

            rows.forEach(row => {
                const values = row.split(',');
                if (values.length < 9) return; // 빈 줄 무시
                const data = {
                    'EMD_NM': values[0],
                    'EMD_CD': values[1],
                    'grade': values[2],
                    'popular': values[3],
                    'busstop_cnt': values[4],
                    'busline_cnt': values[5],
                    'subway_cnt': values[6],
                    'centroid_lon': parseFloat(values[7]),
                    'centroid_lat': parseFloat(values[8])
                   
                };
                const position = {
                    content: `<div class="infowindow">
                                <p><strong>${data['EMD_NM']}</strong></p>
                                <p>교통지수: ${data['grade']}</p>
                                <p>인구수: ${data['popular']}</p>
                                <p>버스정거장수: ${data['busstop_cnt']}</p>
                                <p>버스노선수: ${data['busline_cnt']}</p>
                                <p>지하철역수: ${data['subway_cnt']}</p>
                              </div>`, 
                    latlng: new kakao.maps.LatLng(data['centroid_lat'], data['centroid_lon'])  
                };

                // 마커를 생성합니다
                const marker = new kakao.maps.Marker({
                    map: map, // 마커를 표시할 지도
                    position: position.latlng // 마커의 위치
                });

                // 마커에 표시할 인포윈도우를 생성합니다 
                const infowindow = new kakao.maps.InfoWindow({
                    content: position.content // 인포윈도우에 표시할 내용
                });

                // 마커에 mouseover 이벤트를 등록합니다
                kakao.maps.event.addListener(marker, 'mouseover', function() {
                    infowindow.open(map, marker);
                });

                // 마커에 click 이벤트를 등록합니다
                kakao.maps.event.addListener(marker, 'click', function() {
                    // 이전에 열린 인포윈도우가 있다면 닫기
                    if (prevInfowindow) {
                        prevInfowindow.close();
                    }
                    
                    // 클릭된 마커에 인포윈도우 열기
                    infowindow.open(map, marker);
                    
                    // 현재 열린 인포윈도우를 prevInfowindow에 저장
                    prevInfowindow = infowindow;
                });

                // 마커에 mouseout 이벤트를 등록합니다
                kakao.maps.event.addListener(marker, 'mouseout', function() {
                    infowindow.close();
                });
            });
        }

        // CSV 파일을 로드합니다
        loadCSV();
    </script>
</body>
</html>
